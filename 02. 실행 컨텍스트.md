# 학습 목표

- 실행 컨텍스트와 구조에 대해 이해하고 호이스팅과 스코프에 대해 설명할 수 있다.

- 자바스크립트에선 실행 컨텍스트가 활성화 되는 시점에 일어나는 호이스팅, 외부 환경 정보 구성, this값 설정 등 특이한 현상에 대해 이해하고 설명할 수 있다.
- 이해한 내용에 대한 퀴즈를 맞출 수 있다.

# 01 실행 컨텍스트란?

- 실행할 코드에 제공할 환경 정보를 모아놓은 객체
- 실행 컨텍스트를 보기 전 스택과 큐에 대해 알아보자.

## 스택(Stack)과 큐(queue)

### 스택이란?

- 출입구가 하나뿐인 깊은 우물 같은 데이터 구조
- a, b, c, d 순으로 넣을 시 d, c, b, a 순으로 꺼낼 수 있다.

### 큐(queue)란?

- 양쪽이 모두 열려있는 파이프 형태이나, 양쪽 모두 입출력이 가능한 경우와 한쪽만 입력 다른 한쪽이 출력을 담당하는 구조로 나뉜다.
- 두번 째 경우 큐에 순서대로 a, b, c, d를 저장했다면 꺼낼 때도 a, b, c, d의 순서로 꺼낼 수 있다.

## 실행 컨텍스트

- 실행 컨텍스트(execution context) : 실행할 코드에 제공할 환경 정보들을 모아놓은 객체
- 실행 컨텍스트의 동작은 동일한 환경에 있는 코드들을 실행할 때 필요한 환경 정보들을 모아 컨텍스트를 구성하고, 이를 콜 스택(call Stack)에 쌓아올렸다가, 가장 위의 컨텍스트와 관련 있는 코드들을 실행하는 식으로 전체 코드의 환경과 순서를 보장한다.

### 실행 컨텍스트를 구성하는 방법

- 전역공간, eval(), 함수 등이 있다.
- 전역공간과 eval을 제외하면 우리가 흔히 실행 컨텍스트를 구성하는 방법은 **함수를 실행**하는 것 뿐이다.

## 실행 컨텍스트와 콜 스택

- 콜 스택에 실행 컨텍스트가 어떤 순서로 쌓이고, 어떤 순서로 실행에 관여하는 지 알아보자.

```javascript
//----------------------------(1)
var a = 1;
function outer() {
  function inner() {
    console.log(a); //undefined
    var a = 3;
  }
  inner(); //-------------------(2)
  console.log(a); // 1
}
outer(); //--------------(3)
console.log(a); // 1
```

### 실행순서

- 코어자바스크립트 책 39p 그림 2-3 참고
- (1) -> (3) -> (2) -> (3) -> 다음 코드

  > 1. 전역 컨텍스트(1)가 콜 스택에 먼저 담긴다.
  > 2. 위에서 아래로 실행되다 (3)outer 함수를 콜 스택에 담는다.
  > 3. outer 실행 컨텍스트와 관련 코드인 outer 함수 내부 코드들을 순차로 실행한다.
  > 4. inner 함수(2)의 실행 컨텍스트가 콜 스택 가장 위에 담기면 outer 컨텍스트와 관련된 코드 실행을 중단한다.
  > 5. inner 함수 내부 코드를 순서대로 실행하며 a 변수에 리터럴 3을 할당한다
  > 6. inner 함수 실행이 종료되며 inner 실행 컨텍스트가 제거된다.
  > 7. 다음 아래에 outer 함수에 값이 할당 되어 outer 실행 컨텍스트도 콜 스택에서 제거된다.
  > 8. (3)의 다음 줄부터 이어서 실행이되고 a변수의 값을 출력하고 나면 전역공간(1)에는 실행할 코드가 남아있지 않아 전역 컨텍스트도 제거된다.
  > 9. 콜 스택에는 아무것도 남지않은 상태로 종료된다.

- 이처럼 실행 컨텍스트가 콜 스택 맨 위에 쌓이는 순간, 자바스크립트 엔진은 해당 컨텍스트에 관련된 코드들을 실행하는 데 필요한 환경 정보들을 수집해서 실행 컨텍스트 객체에 저장한다.

## 실행 컨텍스트의 구조

- 실행 컨텍스트는 활성화 된 시점에 variableEnvironment, LexicalEnvironment, thisBinding을 수집한다.

- **variableEnvironment** : 현재 컨텍스트 내의 식별자들에 대한 정보 + 외부 환경 정보, 선언 시점의 LexicalEnvironment의 스냅샷(snapshot)으로, 변경 사항은 반영되지 않는다.
- **LexicalEnvironment** : 처음에는 VariableEnvironmrnt와 같지만 변경 사항이 실시간으로 반영된다.
- **thisBinding** : 식별자가 바라봐야 할 대상 객체.

# 02 VaricableEnviroment

- variableEnvironment는 실행 컨텍스트 생성 시의 스냅샷을 유지하면서 정보를 담는 역할을 하고, 이 정보는 이후에 LexicalEnvironment로 복사된다.
- 실행 컨텍스트가 생성될 때 variableEnvironment에는 정보를 먼저 담은 다음, 이를 LexicalEnvironment로 복사하여 LexicalEnvironment를 주로 활용한다.
- variableEnvironment와 LexicalEnvironment는 모두 EnviromentRecord와 outer-EnvironmentReference로 구성되어 있다.
- 초기화 과정에서는 두 환경이 사실상 동일하게 작동하며, 코드 진행에 따라 서로 다르게 동작하게 된다.

# 03 LexicalEnvironment

## (1) environmentRecord와 호이스팅

### environmentRecord

- environmentRecord에는 현재 컨텍스트와 관련된 코드의 식별자 정보들이 저장된다.
- 컨텍스트 내부 전체를 순서대로 수집한다.

### 호이스팅 규칙

- 변수 및 함수 선언이 스코프의 상단으로 끌어올려지는 현상
- 호이스팅에 대한 예문 및 설명은 코어자바스크립트 책 42 페이지~ 47 페이지를 정독해보자.

### 함수 선언문과 함수 표현식

#### 함수를 정의하는 세 가지 방식

- 함수 선언문
- 함수 표현식(변수에 함수를 할당하는 함수 표현식)
- 기명 함수 표현식 (변수에 함수를 할당하며 함수명을 정하는 함수 표현식)
